<script>
    const TB_ITENS = 'TB_ITENS';
    const TB_MENU = 'TB_MENU';
    let itensMenu = {}
    let itensLista = {}

    function getData(tabela) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler((data) => resolve(data))
          .withFailureHandler((error) => reject(error))
          .getAllData(tabela);
      });
    }

    function addData(tabela, dados) {
      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .addData(tabela, dados);
    }
  
    function onSuccess(response) {
      if (response.success) {
        alert(response.message, 'success');
      } else {
        alert(response.message, 'error');
      }
    }
    
    function onFailure(error) {        
      alert('Erro ao comunicar com o servidor: ' + error.message, 'error');
    }

    function onFilter(idMenu){
      if (!idMenu && !itensLista.length === 0) {
        console.log('ID do menu inválido ou lista de itens vazia.');
        return;
      }
      const itens = itensLista.filter(item => item.idMenu === idMenu);
      injectItensHTML(itens);
    }

    function processData(dados) {
      if (dados.length === 0) {
        console.log('Nenhum dado disponível.');
        return;
      }

      const keys = processKeys(dados[0]);
      const itens = dados.slice(1).map(linha => {
        const item = {};
        keys.forEach((key, index) => {
          item[key] = linha[index];
        });
        return item;
      });

      return itens;
    }

    function processKeys(keys) {
      if (!keys || keys.length === 0) {
        console.log('Nenhuma chave disponível.');
        return [];
      }

      return keys.map(key => {
        const str = String(key).trim().toLowerCase();
        
        return str
          .split(/[-_]/)
          .map((word, index) => {
            if (index === 0) return word;
            return word.charAt(0).toUpperCase() + word.slice(1);
          })
          .join('');
      });
    }

    function injectItensHTML(itens) {
      if (!itens || itens.length === 0) {
        console.log('Nenhum item para exibir.');
        return;
      }

      const container = document.getElementById('container_itens');
      const html = itens.map(item => `
        <div class="mx-auto overflow-hidden rounded-xl bg-white shadow-md">
          <div class="flex w-100 flex-row items-center">
            <img
              class="max-h-30 max-w-30 md:w-full md:h-full object-cover"
              src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSf3_uqLKuV2UWiz3NH9QhLz_VBSXd3_OTMyQ&s"
              alt="Modern building architecture"
            />

            <div class="p-2">
              <div class="text-sm font-semibold tracking-wide text-indigo-500 uppercase">${item.titulo}</div>
              <p class="text-xs text-gray-500"> ${item.descricao} </p>
            </div>
          </div>
        </div>
      `).join('');
      container.innerHTML = html;
    }
    
    function injectMenuHTML(menu) {
      if (!menu || menu.length === 0) {
        console.log('Nenhum item para exibir.');
        return;
      }

      const container = document.getElementById('container_menu');
      const html = menu.map(item => `
          <div class="p-2 w-17 h-17 flex justify-center items-center flex-col bg-white rounded-sm cursor-pointer hover:bg-gray-200" onclick="onFilter(${item.idMenu})">
            <svg class="fill-gray-800" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#e3e3e3"> ${item.pathSvg} </svg>
            <p class="font-medium text-xs"> ${item.descricao} </p>
          </div>
      `).join('');
      container.innerHTML = html;
    }

    function navigateTo(url) {
      top.location.href = url;
    }

    getData(TB_MENU).then((data) => {
      const menu = processData(data);
      injectMenuHTML(menu);
      itensMenu = menu;
    }).catch((error) => {
      console.error('Erro ao obter dados do servidor:', error);
    });

    getData(TB_ITENS).then((data) => {
      const itens = processData(data);
      injectItensHTML(itens);
      itensLista = itens;
    }).catch((error) => {
      console.error('Erro ao obter dados do servidor:', error);
    });
    
</script>